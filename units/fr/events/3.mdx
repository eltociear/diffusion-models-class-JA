# Sprint Dreambooth en Keras

Cette paget r√©sume toutes les informations pertinentes requises pour l'√©v√©nement. üìã.

## Introduction

Dreambooth est une technique de *finetuning* permettant d'enseigner de nouveaux concepts visuels √† des mod√®les de diffusion conditionn√©s par le texte en utilisant seulement 3 √† 5 images. Avec Dreambooth, vous pouvez g√©n√©rer des images dr√¥les et r√©alistes de votre chien, de vous-m√™me et de n'importe quel concept avec quelques images en utilisant Stable Diffusion. 
DreamBooth a √©t√© propos√© dans [DreamBooth : Fine Tuning Text-to-Image Diffusion Models for Subject-Driven Generation] (https://arxiv.org/abs/2208.12242) par Ruiz et al. (2022)

Nous allons entra√Æner les mod√®les Dreambooth √† l'aide de KerasCV et construire des d√©monstrations sur ces mod√®les. 


## Dates importantes

- Lancement de l'√©v√©nement : 6 mars 2023  
Avec Nataniel Ruiz sur DreamBooth, Fran√ßois Chollet sur KerasCV et Apolinario Passos sur ü§ó Diffusers
<Youtube id="Njt8BuSW-TQ" />  

- D√©but du sprint : 7 mars 2023
- Fin du sprint : 1er avril 2023
- R√©sultats : 7 avril 2023


## Getting Started üöÄ 

To get started, join us in [hf.co/join/discord](http://hf.co/join/discord) and take the role #open-source, and meet us in #keras-working-group channel. 

We will be hosting our demos in this organization on Hugging Face Hub: [keras-dreambooth](https://huggingface.co/keras-dreambooth), send a request to join [here](https://huggingface.co/organizations/keras-dreambooth/share/RMocthadPgpxxUDHtAesrbBzieDLgUfPmv) if you‚Äôd like to make a submission üôÇ

We will:

1. Fine-tune Stable Diffusion on any concept we want using Dreambooth,
2. Push the model to Hugging Face Hub,
3. Fill the model card,
4. Build a demo on top of the model.

**Warning:** The trained models need to be in one of the 4 categories mentioned in the Submission section. Please take a look at that before training your model.


## D√©marrer üöÄ 

Pour commencer, rejoignez-nous sur [hf.co/join/discord](http://hf.co/join/discord) et prenez le r√¥le #open-source, et rencontrez-nous sur le canal #keras-working-group. 

Nous h√©bergerons nos d√©monstrations dans cette organisation sur Hugging Face Hub : [keras-dreambooth](https://huggingface.co/keras-dreambooth), envoyez une demande [ici](https://huggingface.co/organizations/keras-dreambooth/share/RMocthadPgpxxUDHtAesrbBzieDLgUfPmv) si vous souhaitez soumettre une proposition üôÇ

Nous allons :

1. *Finetuner* Stable Diffusion sur n'importe quel concept que nous voulons en utilisant Dreambooth,
2. Pousser le mod√®le vers le *Hub* d'Hugging Face,
3. Remplir la carte du mod√®le,
4. Construire une d√©mo √† partir du mod√®le.

**Avertissement:** Les mod√®les entra√Æn√©s doivent √™tre dans l'une des 4 cat√©gories mentionn√©es dans la section Soumission. Veuillez y jeter un coup d'≈ìil avant d'entra√Æner votre mod√®le.


## Entra√Ænement du mod√®le

Vous pouvez trouver le notebook [ici](https://colab.research.google.com/github/huggingface/community-events/blob/main/keras-dreambooth-sprint/Dreambooth_on_Hub.ipynb) (en anglais) et l'adapter √† votre propre jeu de donn√©es.

Quelques inspirations pour le *finetuning* : 

1. *Lowpoly World* : Ce [mod√®le](https://huggingface.co/MirageML/lowpoly-world) g√©n√®re des mondes *low poly* ü§Øüåç
2. *Future Diffusion* : Ce [mod√®le](https://huggingface.co/nitrosocke/Future-Diffusion) g√©n√®re des images dans des concepts de science-fiction futuristes ü§ñ
3. *Fantasy sword* : Ce [mod√®le](https://huggingface.co/MirageML/fantasy-sword) g√©n√®re des √©p√©es pour des jeux √† th√®me fantastique üßô‚Äç‚ôÇÔ∏è

Si vous avez besoin de plus d'indications sur l'impl√©mentation de Dreambooth avec Keras, vous pouvez consulter [ce d√©p√¥t](https://github.com/sayakpaul/dreambooth-keras). 


## Dreambooth avec KerasCV

Pour l'instant, les options d'inf√©rence et de d√©ploiement de `KerasCV` sont limit√©es, et c'est l√† que la biblioth√®que `diffusers` vient √† la rescousse. Avec seulement quelques lignes de code, nous pouvons convertir un mod√®le `KerasCV` en un mod√®le `diffusers` et utiliser les pipelines `diffusers` pour effectuer l'inf√©rence. Vous pouvez obtenir plus d'informations [ici](https://huggingface.co/docs/diffusers/main/en/using-diffusers/kerascv). Consultez aussi [ce Space](https://huggingface.co/spaces/sayakpaul/convert-kerascv-sd-diffusers) pour convertir votre mod√®le `KerasCV` en un mod√®le `diffusers`. 

Les d√©p√¥ts `diffusers` sur le Hub b√©n√©ficient d'une API d'inf√©rence gratuite et de petits widgets dans la page du mod√®le o√π les utilisateurs peuvent jouer avec le mod√®le.

```py
from diffusers import StableDiffusionPipeline

# point de contr√¥le de Stable Diffusion converti de KerasCV
model_ckpt = "sayakpaul/text-unet-dogs-kerascv_sd_diffusers_pipeline"
pipeline = StableDiffusionPipeline.from_pretrained(model_ckpt)
pipeline.to("cuda")

unique_id = "sks"
class_label = "dog"
prompt = f"A photo of {unique_id} {class_label} in a bucket"
image = pipeline(prompt, num_inference_steps=50).images[0]
```

## H√©bergement du mod√®le

√Ä la fin du *notebook* vous verrez une section d√©di√©e √† l'h√©bergement, et une section s√©par√©e pour l'inf√©rence. Nous utiliserons les fonctions de chargement et de pouss√©e de mod√®les sp√©cifiques √† Keras de la biblioth√®que `huggingface_hub` : `push_to_hub_keras` et `from_pretrained_keras`. Nous allons d'abord pousser le mod√®le en utilisant `push_to_hub_keras`. Une fois le mod√®le pouss√©, vous verrez que le mod√®le est h√©berg√© avec une carte de mod√®le comme ci-dessous :

![R√©f√©rentiel](https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/dreamboothrepo.png)

Pour mieux versionner les mod√®les, permettre la d√©couvrabilit√© et la reproductibilit√©, nous allons remplir la carte de mod√®le.  Cliquez sur `*Edit model card*`. Nous allons d'abord remplir la section Metadata de la fiche de mod√®le. Si votre mod√®le est entra√Æn√© avec un jeu de donn√©es du *Hub*, vous pouvez remplir la section des jeux de donn√©es avec le jeu de donn√©es. Nous allons remplir `pipeline_tag` avec `text-to-image` et choisir une licence pour notre mod√®le. 

![M√©tadonn√©es](https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/dreambooth-etadata.png)

Ensuite, nous remplirons la partie markdown. Les hyperparam√®tres et le graphe sont automatiquement g√©n√©r√©s, nous pouvons donc √©crire une courte explication pour la description, l'utilisation pr√©vue et le jeu de donn√©es.

Vous pouvez trouver l'exemple de d√©p√¥t ci-dessous [ici](https://huggingface.co/keras-dreambooth/dreambooth_diffusion_model).


## D√©mo

Nous allons utiliser Gradio pour construire nos d√©monstrations pour les mod√®les que nous avons entra√Æn√©s. Avec la classe `Interface`, c'est simple :

```py
from huggingface_hub import from_pretrained_keras
from keras_cv import models
import gradio as gr

sd_dreambooth_model = models.StableDiffusion(
    img_width=512, img_height=512
)
db_diffusion_model = from_pretrained_keras("merve/dreambooth_diffusion_model")
sd_dreambooth_model._diffusion_model = db_diffusion_model

# g√©n√©rer des images
def infer(prompt):
    generated_images = sd_dreambooth_model.text_to_image(
        prompt
    )
    return generated_images 
    
    
output = gr.Gallery(label="Outputs").style(grid=(2,2))

# la fonction de passage, le type d'entr√©e pour le prompt, la sortie pour les images multiples
gr.Interface(infer, inputs=["text"], outputs=[output]).launch()
```

Vous pouvez consulter le fichier `app.py` de l'application ci-dessous et le r√©utiliser pour votre mod√®le !

[Dreambooth Submission - a Hugging Face Space par keras-dreambooth](https://huggingface.co/spaces/keras-dreambooth/example-submission)

Cette application g√©n√®re des images d'un corgi üê∂ 

![Dreambooth App](https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/dreambooth_corgi.png)

## H√©bergement de la d√©monstration sur Spaces

Une fois notre application termin√©e, nous pouvons cr√©er un *Space* sur Hugging Face pour h√©berger notre application. Vous pouvez aller sur [huggingface.co] (http://huggingface.co), cliquer sur votre profil en haut √† droite et s√©lectionner "*New Space*".

![New Space](https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/new_space.png)

Nous pouvons nommer notre *Space*, choisir une licence et s√©lectionner "*Gradio*" comme Space SDK. 

![Space Configuration](https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/space_config.png)

Apr√®s avoir cr√©√© le *Space*, vous pouvez utiliser soit les instructions ci-dessous pour cloner le d√©p√¥t localement, ajouter vos fichiers et pousser, OU, l'interface graphique pour cr√©er les fichiers et √©crire le code dans le navigateur.

![Spaces Landing](https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/repository_landing.png)

Pour t√©l√©charger votre fichier, cliquez sur "*Add File*" et faites glisser/d√©poser votre fichier.

![New Space Landing](https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/add_file.png)

Enfin, nous devons cr√©er un fichier appel√© `requirements.txt` et ajouter les conditions du projet Dreambooth comme ci-dessous : 

```
keras-cv
tensorflow
huggingface-hub
```

Et votre application devrait √™tre op√©rationnelle !

Nous h√©bergerons nos mod√®les et nos *Spaces* sous [cette organisation] (https://huggingface.co/keras-dreambooth). Vous pouvez transporter vos mod√®les et *Spaces* dans l'onglet param√®tres sous `Rename or transfer this model` et s√©lectionner `keras-dreambooth` dans le menu d√©roulant. 

Si vous ne voyez pas `keras-dreambooth` dans la liste d√©roulante, il est probable que vous ne soyez pas membre de l'organisation. Utilisez [ce lien](https://huggingface.co/organizations/keras-dreambooth/share/bfDDnByLbvPRYypHNUoZJgBgbgtTEYYgVl) pour demander √† rejoindre l'organisation.

## Soumission 

Vous pouvez soumettre votre projet dans trois th√®mes : 

- Nature et animaux (`nature`)
- Univers de science-fiction/fantastique (`sci-fi`)
- Conscient (`consentful`) : Associez-vous √† un artiste pour *finetuner* son style avec son consentement ! Assurez-vous d'inclure une r√©f√©rence au consentement explicite de l'artiste (par exemple un tweet) dans votre carte de mod√®le.
- Carte blanche (`wild-card`) : Si votre soumission appartient √† une cat√©gorie qui n'est pas mentionn√©e ci-dessus, n'h√©sitez pas √† l'√©tiqueter avec `wild-card` afin que nous puissions l'√©valuer en dehors de cette cat√©gorie.

Ajoutez les cat√©gories et leurs identifiants √† votre carte mod√®le et ajoutez `keras-dreambooth` aux m√©tadonn√©es dans la section des tags. Voici un exemple de [carte de mod√®le](https://huggingface.co/spaces/keras-dreambooth/example-submission/blob/main/README.md). Toutes les soumissions seront compil√©es [dans ce classement](https://huggingface.co/spaces/keras-dreambooth/leaderboard) et class√©es en fonction du nombre de likes sur un espace donn√© afin de d√©terminer les gagnants.

## Prix

Nous choisirons trois gagnants parmi les applications soumises, en fonction du nombre de likes accord√©s √† un espace dans une cat√©gorie donn√©e. 

üõçÔ∏è Le premier remportera un bon d'achat de 100$ sur [hf.co/shop](http://hf.co/shop) ou un an d'abonnement √† [Hugging Face Pro](https://huggingface.co/pricing#pro)

üõçÔ∏è La deuxi√®me remportera un bon d'achat de 50$ sur [hf.co/shop](http://hf.co/shop) ou [le livre](https://transformersbook.com/) *Natural Language Processing with Transformers*.

üõçÔ∏è Le troisi√®me remportera un bon d'achat de 30$ sur [hf.co/shop](http://hf.co/shop) ou trois mois d'abonnement √† [Hugging Face Pro](https://huggingface.co/pricing#pro)